<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Haz tu Pedido - Miski Chukulati</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--brown:#3b2314;--gold:#d4af37}
body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--brown),#5c3b1e);color:#fff;min-height:100vh}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(0,0,0,0.45)}
.header img{height:48px;border-radius:50%}
.container{max-width:760px;margin:28px auto;background:rgba(255,255,255,0.04);padding:22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
label{display:block;margin-top:10px;font-weight:600}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(212,197,178,0.12);background:transparent;color:#fff;box-sizing:border-box;margin-top:6px}
.button-primary{background:linear-gradient(90deg,#a67c52,#d4af37);color:#3b2314;font-weight:700;border:none;padding:12px;border-radius:12px;cursor:pointer}
.toggle{display:flex;gap:10px;margin-top:12px}
.toggle button{flex:1;padding:10px;border-radius:10px;border:2px solid var(--gold);background:transparent;color:#fff;cursor:pointer}
.toggle button.active{background:var(--gold);color:#3b2314}
.couriers{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:14px}
.courier-card{background:rgba(255,255,255,0.06);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:transform .15s}
.courier-card:hover{transform:scale(1.03);box-shadow:0 8px 24px rgba(212,175,55,0.18)}
.courier-card img{width:84px;height:84px;border-radius:50%;border:3px solid var(--gold);object-fit:cover}
.stars{color:gold;font-size:1.1rem}
.popup{position:fixed;left:0;top:0;width:100%;height:100%;display:none;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:50}
.popup .box{background:#fffdf8;color:#3b2314;padding:20px;border-radius:14px;border:3px solid var(--gold);width:320px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.3)}
.footer{margin-top:30px;text-align:center;color:#ffd700;padding:14px}
@media(max-width:720px){.container{margin:12px}}
</style>
</head>
<body>
<header class="header">
  <img src="https://github.com/miskichukulati25-rgb/MiskiChukulati/blob/main/logo.png?raw=true" alt="logo">
  <div><a href="index.html" style="color:#ffdca8;text-decoration:none;font-weight:700">Volver</a></div>
</header>

<div class="container">
  <h2>Haz tu Pedido</h2>

  <label>Nombre completo</label><input id="nombre">
  <label>DNI</label><input id="dni" maxlength="8">
  <label>Correo</label><input id="correo" type="email">
  <label>Celular</label><input id="telefono" maxlength="9">
  <label>Dirección de entrega</label><input id="direccion">

  <label>Producto</label>
  <select id="producto" onchange="calcularTotal()">
    <option value="">--Selecciona--</option>
    <option>Tableta 70 % cacao</option>
    <option>Tableta 85 % cacao</option>
    <option>Bombones surtidos</option>
    <option>Dark Chocolate Bar</option>
    <option>ChocoNibs</option>
    <option>ChocoBites</option>
    <option>Chocolate Blanco</option>
  </select>

  <label>Cantidad</label><input id="cantidad" type="number" min="1" value="1" onchange="calcularTotal()">

  <label>Método de pago</label>
  <select id="metodoPago"><option>PLIN</option><option>YAPE</option><option>Transferencia</option><option>Efectivo</option></select>

  <div class="toggle">
    <button id="btnSin" class="active" onclick="setDelivery(false)">Sin delivery</button>
    <button id="btnCon" onclick="setDelivery(true)">Con delivery</button>
  </div>

  <div id="couriers" class="couriers" style="display:none"></div>

  <div style="margin-top:14px">
    <button class="button-primary" onclick="showPopup()">Ver total</button>
  </div>
</div>

<div class="popup" id="popup" role="dialog" aria-hidden="true">
  <div class="box">
    <h3>Resumen del pedido</h3>
    <p>Precio producto: S/ <span id="precioProd">0.00</span></p>
    <p>Comisión envío: S/ <span id="comision">0.00</span></p>
    <hr>
    <p><b>Total a pagar: S/ <span id="pTotal">0.00</span></b></p>
    <div style="margin-top:12px">
      <button class="button-primary" onclick="enviarPedido()">Enviar pedido</button>
    </div>
    <div style="margin-top:8px">
      <button onclick="closePopup()" style="background:transparent;border:none;color:#444">Cancelar</button>
    </div>
  </div>
</div>

<div class="footer">“Jehová te bendiga, y te guarde” – Números 6:24<br>© Miski Chukulati - 2025</div>

<script>
const SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxISyjwQMZSoQ6XMR7JsUv3kG58WQwwizvFqeGUl203UuVWncDSYaKt02zVCw12Q-zgJg/exec";
const precios = {"Tableta 70 % cacao":8,"Tableta 85 % cacao":9,"Bombones surtidos":15,"Dark Chocolate Bar":8,"ChocoNibs":5,"ChocoBites":6.5,"Chocolate Blanco":24};
let conDelivery = false, base = 0, com = 0, total = 0;
let couriers = [], selectedCourier = null;

function setDelivery(v){
  conDelivery = v;
  document.getElementById('btnCon').classList.toggle('active', v);
  document.getElementById('btnSin').classList.toggle('active', !v);
  document.getElementById('couriers').style.display = v ? 'grid' : 'none';
  calcularTotal();
  if (v) loadCouriers();
}

function calcularTotal(){
  const producto = document.getElementById('producto').value;
  const cantidad = Number(document.getElementById('cantidad').value || 1);
  const precioUnit = precios[producto] || 0;
  base = precioUnit * cantidad;
  com = conDelivery ? 7 : 0;
  total = parseFloat((base + com).toFixed(2));
}

function showPopup(){
  calcularTotal();
  document.getElementById('precioProd').innerText = base.toFixed(2);
  document.getElementById('comision').innerText = com.toFixed(2);
  document.getElementById('pTotal').innerText = total.toFixed(2);
  document.getElementById('popup').style.display = 'flex';
}

function closePopup(){ document.getElementById('popup').style.display = 'none'; }

async function loadCouriers(){
  try {
    const res = await fetch(SCRIPT_WEB_APP_URL + "?action=getCouriers");
    couriers = await res.json();
    const container = document.getElementById('couriers');
    container.innerHTML = couriers.map((c,i)=>`
      <div class="courier-card" onclick="selectCourier(${i})">
        <img src="${c.foto||'https://via.placeholder.com/80'}" alt="${c.nombre}">
        <div style="margin-top:8px;font-weight:700">${c.nombre} ${c.apellido||''}</div>
        <div>${c.edad ? c.edad+' años' : ''}</div>
        <div class="stars">${'⭐'.repeat(Math.round(c.puntuacion||5))}</div>
        <div style="font-size:.85rem;color:#ffdca8">${(Number(c.puntuacion)||5).toFixed(1)}</div>
      </div>`).join('');
  } catch(e) {
    console.error("No se cargaron couriers", e);
  }
}

function selectCourier(i){
  selectedCourier = couriers[i];
  document.querySelectorAll('.courier-card').forEach((el,idx)=> el.style.border = idx===i ? '3px solid #ffd700' : 'none');
}

async function enviarPedido(){
  const data = {
    type: "pedido",
    nombre: document.getElementById('nombre').value.trim(),
    dni: document.getElementById('dni').value.trim(),
    correo: document.getElementById('correo').value.trim(),
    telefono: document.getElementById('telefono').value.trim(),
    direccion: document.getElementById('direccion').value.trim(),
    producto: document.getElementById('producto').value,
    cantidad: Number(document.getElementById('cantidad').value||1),
    metodoPago: document.getElementById('metodoPago').value,
    courier: selectedCourier ? selectedCourier.nombre + " " + (selectedCourier.apellido||'') : "",
    calificacion: selectedCourier ? selectedCourier.puntuacion : "",
    conDelivery: conDelivery,
    envio: com
  };
  try {
    const resp = await fetch(SCRIPT_WEB_APP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const json = await resp.json();
    if (json.success) {
      alert('Pedido registrado: ' + json.idPedido + '\nSe abrió tu comprobante.');
      window.open(json.pdfUrl, '_blank');
      closePopup();
      // reset (opcional)
      document.getElementById('producto').value = '';
      document.getElementById('cantidad').value = 1;
    } else {
      alert('Error: '+ (json.error||'No se pudo procesar'));
    }
  } catch(e) {
    console.error(e);
    alert('Error de conexión. Intenta nuevamente.');
  }
}
</script>
</body>
</html>
